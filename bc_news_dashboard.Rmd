---
title: "BC Major Projects News Aggregator"
date: "`r paste('Updated', format(Sys.time(), '%Y/%m/%d %H:%M'))`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: "https://github.com/bcgov/bc_news_aggregator"
resource_files:
- scraped.rds
---

```{r setup, include=FALSE}
#libraries------------------------------------------------
library(dplyr)
library(DT)
library(here)
library(readr)
library(stringr)
library(purrr)
library(conflicted)
conflicts_prefer(dplyr::filter)
#functions-----------------------------------
clean_html <- function(x) {
  x <- gsub("[\r\n]", " ", x)
  x <- gsub('"', "&quot;", x, fixed = TRUE)
  x <- gsub("'", "&#39;", x, fixed = TRUE)
  x
}
list_2_bullets <- function(lst) {
      x <- as.character(unlist(lst))
      if (length(x) == 0 || all(is.na(x))) return("")
      if (length(x) == 1) {x <- unlist(strsplit(x, "(?<=\\.)\\s+", perl = TRUE))}
      paste0("<ul><li>", paste(x, collapse = "</li><li>"), "</li></ul>")
}
#read in the data-----------------------------
projects_bc <- read_rds("scraped.rds")
```

Column
-------------------------------------
    
### News since `r lubridate::ymd_hms(min(projects_bc$publishedAt))`

```{r}
projects_bc |>
  mutate(
    link = sprintf('<a href="%s" target="_blank">%s</a>', url, title),
    query = sub("\\s*AND.*", "", query),
    query = gsub('^"|"$', "", query),     # remove leading/trailing quotes
    query = gsub('"', '', query),         # remove any remaining quotes inside
    query = trimws(query),
    bullets = map_chr(text, list_2_bullets),
    bullets = clean_html(bullets)
    )|>
  ungroup()|>
  select(query, link, bullets, source, publishedAt)|>
  datatable(escape=FALSE,
            rownames=FALSE,
            extensions = "Buttons",
            options = list( 
              dom = "Btip",
              buttons = list(
                list(extend = "csv", filename = "news"),
                list(extend = "excel", filename = "news")),
              pageLength = -1,
              autoWidth = TRUE,
              columnDefs = list(
                list(width = '6%', targets = 0),
                list(width = '6%', targets = 1),
                list(width = '76%', targets = 2), 
                list(width = '6%', targets = 3), 
                list(width = '6%', targets = 4)
                )
            )
  )
```
