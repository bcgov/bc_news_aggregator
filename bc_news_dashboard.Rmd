---
title: "BC Major Projects News Aggregator"
date: "`r paste('Updated',format(Sys.time(), '%Y/%m/%d %H:%M'))`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: "https://github.com/bcgov/bc_news_aggregator"
resource_files:
- data/scraped.rds
---

```{r setup, include=FALSE}
#libraries------------------------------------------------
library(dplyr)
library(DT)
library(here)
library(readr)
library(stringr)
library(purrr)
library(conflicted)
conflicts_prefer(dplyr::filter)
#functions-----------------------------------
my_dt <- function(tbbl) {
  DT::datatable(tbbl,
    filter = 'top',
    extensions = "Buttons",
    rownames = FALSE,
    escape = FALSE,
    options = list(
      pageLength = -1,
    autoWidth = TRUE,
    columnDefs = list(
      list(width = '6%', targets = 0),  # first column
      list(width = '82%', targets = 1),  # first column
      list(width = '6%', targets = 2),  # second column
      list(width = '6%', targets = 3)   # third column
    ),
    scrollX = TRUE,
    scrollY = TRUE,
    searching = TRUE,
    ordering = TRUE,
    dom = "Btip",
    buttons = list(
      list(extend = "csv", filename = "news"),
      list(extend = "excel", filename = "news"))
    )
  )
}
list_2_bullets <- function(lst) {
      x <- as.character(unlist(lst))
      if (length(x) == 0 || all(is.na(x))) return("")
      if (length(x) == 1) {x <- unlist(strsplit(x, "(?<=\\.)\\s+", perl = TRUE))}
      paste0("<ul><li>", paste(x, collapse = "</li><li>"), "</li></ul>")
}

#read in the data-----------------------------
projects_bc <- read_rds(here("data","scraped.rds"))
```

Column
-------------------------------------
    
### News since `r format(min(projects_bc$item_pub_date),'%Y/%m/%d') `

```{r}
projects_bc |>
  mutate(
    link = sprintf('<a href="%s" target="_blank">%s</a>', item_link, item_title),
    key_details = map(key_details, list_2_bullets),
    item_pub_date = format(item_pub_date, '%Y/%m/%d')
  ) |>
  select(link, key_details, item_pub_date, feed) |>
  my_dt()
```
