---
title: "BC Major Projects News Aggregator"
date: "`r paste('Updated', format(Sys.time()-lubridate::hours(8), '%Y/%m/%d %H:%M'))`"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
resource_files:
- scraped.rds
runtime: shiny
---

```{r setup, include=FALSE}
#libraries------------------------------------------------
library(dplyr)
library(DT)
library(here)
library(readr)
library(stringr)
library(purrr)
library(conflicted)
conflicts_prefer(dplyr::filter)
#functions-----------------------------------
clean_html <- function(x) {
  x <- gsub("[\r\n]", " ", x)
  x <- gsub('"', "&quot;", x, fixed = TRUE)
  x <- gsub("'", "&#39;", x, fixed = TRUE)
  x
}
list_2_bullets <- function(lst) {
      x <- as.character(unlist(lst))
      if (length(x) == 0 || all(is.na(x))) return("")
      if (length(x) == 1) {x <- unlist(strsplit(x, "(?<=\\.)\\s+", perl = TRUE))}
      paste0("<ul><li>", paste(x, collapse = "</li><li>"), "</li></ul>")
}
#read in the data-----------------------------
projects_bc <- read_rds("scraped.rds")
```

<a href="https://github.com/bcgov/bc_news_aggregator" target="_blank" rel="noopener">
  <svg height="28" width="28" viewBox="0 0 16 16" aria-hidden="true">
    <path fill="currentColor" 
      d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 
         7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49
         -2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13
         -.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82
         .72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07
         -1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15
         -.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82
         .64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 
         2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 
         1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 
         1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 
         8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
    </path>
  </svg>
</a>

Column
-------------------------------------
    
### News since `r lubridate::ymd_hms(min(projects_bc$publishedAt))`

```{r}
projects_bc |>
  mutate(
    link = sprintf('<a href="%s" target="_blank">%s</a>', url, title),
    query = sub("\\s*AND.*", "", query),
    query = gsub('^"|"$', "", query),     # remove leading/trailing quotes
    query = gsub('"', '', query),         # remove any remaining quotes inside
    query = trimws(query),
    bullets = map_chr(text, list_2_bullets),
    bullets = clean_html(bullets),
    date=str_extract(publishedAt, ".*(?=T)"),
    date=lubridate::ymd(date)
    )|>
  ungroup()|>
  select(query, link, bullets, source, date)|>
  datatable(
  escape = FALSE,
  rownames = FALSE,
  extensions = "Buttons",
  filter = "none",  # important â€” we are doing custom filtering
  options = list(
    dom = '<"date-range">Btip',   # creates area for date inputs
    pageLength = -1,
    autoWidth = TRUE,

    # -------------------------------
    # 1. Add dropdown filter for column 0 (your existing one)
    # -------------------------------
    initComplete = JS(
      "function(settings, json) {",

      "  // ---- Dropdown filter on column 0 ----",
      "  var column = this.api().column(0);",
      "  var select = $('<select><option value=\"\"></option></select>')",
      "    .appendTo($(column.header()).empty())",
      "    .on('change', function() {",
      "      var val = $.fn.dataTable.util.escapeRegex($(this).val());",
      "      column.search(val ? '^'+val+'$' : '', true, false).draw();",
      "    });",
      "  column.data().unique().sort().each(function(d, j) {",
      "    select.append('<option value=\"'+d+'\">'+d+'</option>');",
      "  });",

      "  // ---- Insert date range inputs ----",
      "  $('div.date-range').html(",
      "    '<label>From: <input type=\"date\" id=\"minDate\"></label> ' +",
      "    '<label>To: <input type=\"date\" id=\"maxDate\"></label>'",
      "  );",

      "  var table = this.api();",

      "  // Trigger filtering when dates change",
      "  $('#minDate, #maxDate').on('change', function() { table.draw(); });",

      "}"
    ),

    # -------------------------------
    # 2. Column widths
    # -------------------------------
    columnDefs = list(
      list(width = '6%', targets = 0),
      list(width = '6%', targets = 1),
      list(width = '76%', targets = 2),
      list(width = '6%', targets = 3),
      list(width = '6%', targets = 4)
    ),

    # -------------------------------
    # 3. Export buttons
    # -------------------------------
    buttons = list(
      list(extend = "csv", filename = "news"),
      list(extend = "excel", filename = "news")
    )
  ),

  # -------------------------------
  # 4. The actual date-range filtering logic
  #    (assumes column 4 contains the date)
  # -------------------------------
  callback = JS(
    "
    $.fn.dataTable.ext.search.push(
      function(settings, data, dataIndex) {

        // Extract date text from column 4 (0-indexed)
        var date = data[4] || '';

        // Inputs from date pickers
        var min = $('#minDate').val();
        var max = $('#maxDate').val();

        // If no filter set, accept row
        if (!min && !max) return true;

        // Compare in YYYY-MM-DD format (lexical comparison works)
        if (min && date < min) return false;
        if (max && date > max) return false;

        return true;
      }
    );
    "
  )
)
```
